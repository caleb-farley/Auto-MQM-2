<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto-MQM</title>
  <!-- CSS files -->
  <link href="css/styles.css" rel="stylesheet">
  <link href="css/admin-styles.css" rel="stylesheet">
  <!-- Stripe Elements script (only loaded when needed) -->
  <meta name="stripe-public-key" content="pk_test_your_stripe_public_key_here">
  <!-- JavaScript files -->
  <script src="js/utils.js"></script>
  <script src="js/core.js"></script>
  <script src="js/translation.js"></script>
  <script src="js/analysis.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/excelReports.js"></script>
  <script src="js/toggle.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/modals.js"></script>
  <script src="js/fix.js"></script>
  <script src="js/text-input-fix.js"></script>
  <script src="js/admin-fix.js"></script>
  <script src="js/translation-fix.js"></script>
  <script src="js/file-upload-fix.js"></script>

</head>
<body>
  <div class="container">
    <div class="header">
        <div class="logo-container">
            <a href="https://www.orca-ls.com/" target="_blank" rel="noopener noreferrer">
                <img src="/images/Orca-Logo_White.png" alt="ORCA Logo" class="logo-img" />
              </a>
              <h1 class="title">FastFin</h1>              
        </div>
        <div class="flex items-center">
          <!-- Authentication UI -->
          <div class="auth-container">
            <!-- Auth buttons for logged out users -->
            <div class="auth-buttons" id="auth-buttons">
              <button class="btn btn-secondary" id="login-btn">Log In</button>
              <button class="btn btn-primary" id="register-btn">Register</button>
            </div>
            
            <!-- User info for logged in users -->
            <div class="user-info" id="user-info">
              <div class="user-avatar" id="user-avatar">U</div>
              <div class="user-details">
                <span class="user-name" id="user-name">user@example.com</span>
                <div class="user-actions">
                  <a href="#" id="dashboard-link" onclick="showDashboardModal(); return false;">Dashboard</a>
                  <a href="#" id="account-link" onclick="showAccountModal(); return false;">Account</a>
                  <a href="#" id="admin-link" class="admin-link" onclick="showAdminModal(); return false;">Admin</a>
                  <a href="#" id="logout-link" onclick="logout(); return false;">Log Out</a>
                </div>
              </div>
            </div>
            
            <!-- Usage tracking -->
            <div class="usage-info" id="usage-info">
              <div class="account-type">Anonymous User</div>
              <div class="usage-count">0 of 5 runs used</div>
              <div class="usage-progress-container">
                <div class="usage-progress usage-progress-bar" id="usage-progress"></div>
              </div>
            </div>
          </div>
          
          <div class="subtitle ml-4">
            <a href="https://orca-ls.com" target="_blank" rel="noopener noreferrer" class="orca-link">
              Powered by <span class="orca-link-underline">Orca LS</span>
            </a>
          </div>
        </div>
      </div>
      
      <div class="info-box">
        <p>
          <strong>FastFin</strong> is the next generation platform for managing and producing high quality translations powered by AI. 
          This comprehensive translation and localization quality assessment tool uses the 
          <a href="https://themqm.org/" target="_blank" rel="noopener noreferrer" class="mqm-link">
            <span>Learn more about MQM</span>
          </a> (MQM) framework to analyze your multilingual content and ensure translation accuracy.
        </p>
        <p class="margin-top-10">
          Auto-MQM uses advanced AI to automatically identify and categorize translation issues according to the MQM framework, saving you time and improving consistency in quality assessment. 
          FastFin will identify issues in accuracy, fluency, and terminology, providing suggested fixes that you can apply with a single click. 
          Switch between bilingual mode (source and target text) and monolingual mode (target text only) using the toggle above.
          <strong>Maximum 500 words.</strong>
        </p>
        <p style="margin-top: 10px;">
          <strong>Excel Integration: </strong>Download our bilingual Excel template to prepare and document your translations offline. The template includes structured fields for source and target text, language codes, and custom issue annotations. Once completed, upload the file to automatically process and visualize your quality assessment results.
        </p>
      </div>
        
  <!-- Section Headers -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
  <!-- Translation Content Heading -->
  <div style="display: inline-block;">
    <label class="text-area-label gothic-title" style="font-size: 18px; font-weight: 600;">
      Translation Content
    </label>
  </div>
  
  <!-- Translation Type Toggle -->
  <div style="display: inline-block;">
    <div class="translation-toggle">
      <label class="text-area-label gothic-title" for="translation-mode" style="font-size: 18px; font-weight: 600;">
        Translation Mode
        <span class="info-icon" onmouseover="this.querySelector('.tooltip-text').style.visibility='visible'" onmouseout="this.querySelector('.tooltip-text').style.visibility='hidden'">&#9432;
          <span class="tooltip-text">
            <strong>Bilingual Mode:</strong> Analyze translations from one language to another.<br><br>
            <strong>Monolingual Mode:</strong> Analyze text quality in a single language without translation.
          </span>
        </span>
      </label>
      <div class="toggle-switch-container">
        <span class="toggle-label">Bilingual</span>
        <label class="switch">
          <input type="checkbox" id="translation-mode-toggle">
          <span class="slider round"></span>
        </label>
        <span class="toggle-label">Monolingual</span>
      </div>
      <div class="model-selector-container">
        <label for="llm-model" class="model-selector-label">Model:</label>
        <select id="llm-model" class="form-control model-selector">
          <option value="claude-3-opus-20240229">Claude 3 Opus</option>
          <option value="claude-3-sonnet-20240229" selected>Claude 3 Sonnet</option>
          <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
        </select>
        <span class="info-icon" onmouseover="this.querySelector('.tooltip-text').style.visibility='visible'" onmouseout="this.querySelector('.tooltip-text').style.visibility='hidden'">&#9432;
          <span class="tooltip-text">
            <strong>Claude 3 Opus:</strong> Most powerful model with highest quality and accuracy.<br><br>
            <strong>Claude 3 Sonnet:</strong> Balanced performance with good quality and speed.<br><br>
            <strong>Claude 3 Haiku:</strong> Fastest model, ideal for quick analyses.
          </span>
        </span>
      </div>
    </div>
  </div>
</div>

<script>
  // Add this script to handle the toggle switch functionality and bidirectional text support
  document.addEventListener('DOMContentLoaded', function() {
    // RTL language codes
    const rtlLanguages = ['ar', 'he', 'fa', 'ur'];
    
    // Function to check if a language is RTL
    function isRTL(langCode) {
      if (!langCode) return false;
      // Check if the language code starts with any RTL language prefix
      return rtlLanguages.some(rtlCode => langCode.startsWith(rtlCode));
    }
    
    // Function to update text direction based on language
    function updateTextDirection() {
      const sourceLang = document.getElementById('source-lang').value;
      const targetLang = document.getElementById('target-lang').value;
      const sourceText = document.getElementById('source-text');
      const targetText = document.getElementById('target-text');
      
      // Set text direction based on language (while keeping dir='auto' for automatic detection)
      if (sourceLang && isRTL(sourceLang)) {
        sourceText.style.textAlign = 'right';
      } else if (sourceLang) {
        sourceText.style.textAlign = 'left';
      }
      
      if (targetLang && isRTL(targetLang)) {
        targetText.style.textAlign = 'right';
      } else if (targetLang) {
        targetText.style.textAlign = 'left';
      }
    }
    
    // Add event listeners for language selection changes
    document.getElementById('source-lang').addEventListener('change', updateTextDirection);
    document.getElementById('target-lang').addEventListener('change', updateTextDirection);
    const translationToggle = document.getElementById('translation-mode-toggle');
    const bilingualRadio = document.querySelector('input[name="translation-mode"][value="bilingual"]');
    const monolingualRadio = document.querySelector('input[name="translation-mode"][value="monolingual"]');
    const translateBtn = document.getElementById('translate-btn');
    // Function to toggle source text visibility - simplified and robust approach
    function toggleSourceTextVisibility(isMonolingual) {
      // Use direct IDs for maximum reliability
      const sourceContainer = document.getElementById('source-text-container');
      const targetContainer = document.getElementById('target-text-container');
      const sourceText = document.getElementById('source-text');
      const sourceLang = document.getElementById('source-lang');
      const textAreasContainer = document.getElementById('text-areas-container');
      
      console.log('Toggle called with isMonolingual:', isMonolingual);
      
      // Set global state for reference
      window.isMonolingualMode = isMonolingual;
      
      // Add CSS to document if not already present
      if (!document.getElementById('monolingual-mode-styles')) {
        const styleEl = document.createElement('style');
        styleEl.id = 'monolingual-mode-styles';
        styleEl.textContent = `
          .monolingual-mode #source-text-container {
            display: none !important;
          }
          .monolingual-mode #target-text-container {
            width: 100% !important;
            flex: 1 0 100% !important;
          }
          .monolingual-mode #translate-btn {
            display: none !important;
          }
          .hidden {
            display: none !important;
          }
        `;
        document.head.appendChild(styleEl);
      }
      
      // Force a redraw by accessing offsetHeight
      document.body.offsetHeight;
      
      if (isMonolingual) {
        // MONOLINGUAL MODE
        console.log('Activating monolingual mode');
        
        // Add monolingual class to body and container for CSS targeting
        document.body.classList.add('monolingual-mode');
        textAreasContainer.classList.add('monolingual-mode');
        
        // Hide the translate button in monolingual mode
        const translateBtn = document.getElementById('translate-btn');
        if (translateBtn) translateBtn.style.display = 'none';
        
        // Clear source inputs since they won't be used
        if (sourceText) sourceText.value = '';
        
        // Directly hide the source container with inline style for maximum compatibility
        if (sourceContainer) {
          sourceContainer.classList.add('hidden');
        }
        
        // Directly set the target container to full width
        if (targetContainer) {
          targetContainer.style.width = '100%';
          targetContainer.style.flex = '1 0 100%';
        }
        
        // Add a visual indicator that we're in monolingual mode
        const modeIndicator = document.createElement('div');
        modeIndicator.id = 'monolingual-indicator';
        modeIndicator.textContent = 'Monolingual Mode Active';
        modeIndicator.style.background = '#2a6b8f';
        modeIndicator.style.color = 'white';
        modeIndicator.style.padding = '5px 10px';
        modeIndicator.style.borderRadius = '4px';
        modeIndicator.style.fontSize = '12px';
        modeIndicator.style.marginBottom = '10px';
        modeIndicator.style.display = 'inline-block';
        
        // Remove any existing indicator first
        const existingIndicator = document.getElementById('monolingual-indicator');
        if (existingIndicator) existingIndicator.remove();
        
        // Add the indicator before the target container
        if (targetContainer && targetContainer.parentNode) {
          targetContainer.parentNode.insertBefore(modeIndicator, targetContainer);
        }
      } else {
        // BILINGUAL MODE
        console.log('Activating bilingual mode');
        
        // Remove monolingual mode classes
        document.body.classList.remove('monolingual-mode');
        textAreasContainer.classList.remove('monolingual-mode');
        
        // Show the translate button in bilingual mode
        const translateBtn = document.getElementById('translate-btn');
        if (translateBtn) translateBtn.style.display = 'block';
        
        // Show source container
        if (sourceContainer) sourceContainer.style.display = 'block';
        
        // Reset the target container width
        if (targetContainer) {
          targetContainer.style.width = '';
          targetContainer.style.flex = '';
        }
        
        // Remove the monolingual mode indicator if it exists
        const modeIndicator = document.getElementById('monolingual-indicator');
        if (modeIndicator) modeIndicator.remove();
      }
      
      // Force immediate update of the analyze button validation
      updateAnalyzeButton();
      
      // For debugging - output the current display style
      if (sourceContainer) {
        console.log('Source container computed style:', window.getComputedStyle(sourceContainer).display);
      }
    }
    
    // Initialize toggle based on radio button state (if it exists)
    if (bilingualRadio && monolingualRadio) {
      translationToggle.checked = monolingualRadio.checked;
      // Set initial visibility based on current toggle state
      toggleSourceTextVisibility(translationToggle.checked);
    }
    
    // Call the toggle function on page load to set initial state and ensure it's applied
    window.addEventListener('DOMContentLoaded', function() {
      // Force an initial toggle based on current state
      const isMonolingual = translationToggle.checked;
      toggleSourceTextVisibility(isMonolingual);
      
      // Set initial data attribute for potential CSS targeting
      document.body.setAttribute('data-translation-mode', isMonolingual ? 'monolingual' : 'bilingual');
      
      // Initialize global state variable
      window.isMonolingualMode = isMonolingual;
      
      console.log('DOMContentLoaded: Monolingual mode initialized to', isMonolingual);
    });
    
    // Handle toggle changes
    translationToggle.addEventListener('change', function() {
      const isMonolingual = this.checked;
      console.log('Toggle changed to:', isMonolingual ? 'monolingual' : 'bilingual');
      
      if (bilingualRadio && monolingualRadio) {
        if (isMonolingual) {
          monolingualRadio.checked = true;
          bilingualRadio.checked = false;
          // Set a data attribute on the body to allow for CSS targeting
          document.body.setAttribute('data-translation-mode', 'monolingual');
        } else {
          bilingualRadio.checked = true;
          monolingualRadio.checked = false;
          document.body.setAttribute('data-translation-mode', 'bilingual');
        }
        
        // Update UI based on toggle state - force immediate update
        toggleSourceTextVisibility(isMonolingual);
        
        // Also update the analyze button state
        updateAnalyzeButton();
        
        // Trigger change event on radio buttons to ensure any existing handlers work
        const event = new Event('change');
        if (this.checked) {
          monolingualRadio.dispatchEvent(event);
        } else {
          bilingualRadio.dispatchEvent(event);
        }
        
        // Dispatch a custom event that other parts of the code can listen for
        const modeChangedEvent = new CustomEvent('translation-mode-changed', {
          detail: { isMonolingual: isMonolingual }
        });
        document.dispatchEvent(modeChangedEvent);
        
        // Log the current state for debugging
        console.log('Translation mode changed:', this.checked ? 'Monolingual' : 'Bilingual');
      }
    });
    
    // Add a direct click handler to the toggle labels to improve usability
    document.querySelectorAll('.toggle-switch-container > span').forEach(function(label) {
      label.addEventListener('click', function() {
        if (this.textContent.trim() === 'Bilingual') {
          translationToggle.checked = false;
        } else if (this.textContent.trim() === 'Monolingual') {
          translationToggle.checked = true;
        }
        // Trigger the change event
        translationToggle.dispatchEvent(new Event('change'));
      });
    });
  });
</script>      
    
    <!-- Translation Generator Feature -->
    <div class="translate-section">
      <div class="translate-section-header">
        <p style="margin-bottom: 5px;">
          <span class="gothic-title translate-section-title">Automated Translations</span>
          <span class="translate-section-description"> - Need a quick translation? We can automatically generate a translation from your source text. We'll use the best available translation engine based on your selected languages.</span>
        </p>
      </div>
      <div id="translation-engine-info" class="translation-engine-info"></div>
    </div>
    
    <!-- Text areas -->
    <div class="text-areas" id="text-areas-container">
      <!-- Source text -->
      <div class="text-area-container" id="source-text-container">
        <div class="text-area-header">
          <label class="text-area-label" id="source-text-label">Source Text:</label>
          <select id="source-lang">
            <option value="">-- Select Language --</option>
            <option value="en">🇬🇧 English</option>
            <option value="en-US">🇺🇸 English (US)</option>
            <option value="en-GB">🇬🇧 English (UK)</option>
            <option value="en-CA">🇨🇦 English (Canada)</option>
            <option value="en-AU">🇦🇺 English (Australia)</option>
            
            <option value="es">🇪🇸 Spanish</option>
            <option value="es-ES">🇪🇸 Spanish (Spain)</option>
            <option value="es-MX">🇲🇽 Spanish (Mexico)</option>
            <option value="es-CO">🇨🇴 Spanish (Colombia)</option>
            <option value="es-AR">🇦🇷 Spanish (Argentina)</option>
            
            <option value="fr">🇫🇷 French</option>
            <option value="fr-FR">🇫🇷 French (France)</option>
            <option value="fr-CA">🇨🇦 French (Canada)</option>
            <option value="fr-BE">🇧🇪 French (Belgium)</option>
            <option value="fr-CH">🇨🇭 French (Switzerland)</option>
            
            <option value="pt">🇵🇹 Portuguese</option>
            <option value="pt-PT">🇵🇹 Portuguese (Portugal)</option>
            <option value="pt-BR">🇧🇷 Portuguese (Brazil)</option>
            
            <option value="zh">🇨🇳 Chinese (Mandarin)</option>
            <option value="zh-CN">🇨🇳 Chinese (Simplified, China)</option>
            <option value="zh-TW">🇹🇼 Chinese (Traditional, Taiwan)</option>
            <option value="zh-HK">🇭🇰 Chinese (Traditional, Hong Kong)</option>
            <option value="zh-SG">🇸🇬 Chinese (Singapore)</option>
            
            <option value="ar">🇸🇦 Arabic</option>
            <option value="ar-SA">🇸🇦 Arabic (Saudi Arabia)</option>
            <option value="ar-EG">🇪🇬 Arabic (Egypt)</option>
            <option value="ar-AE">🇦🇪 Arabic (UAE)</option>
            <option value="ar-MA">🇲🇦 Arabic (Morocco)</option>
            
            <option value="de">🇩🇪 German</option>
            <option value="de-DE">🇩🇪 German (Germany)</option>
            <option value="de-AT">🇦🇹 German (Austria)</option>
            <option value="de-CH">🇨🇭 German (Switzerland)</option>
            
            <option value="it">🇮🇹 Italian</option>
            <option value="ja">🇯🇵 Japanese</option>
            <option value="ko">🇰🇷 Korean</option>
            <option value="ru">🇷🇺 Russian</option>
            <option value="hi">🇮🇳 Hindi</option>
            <option value="bn">🇧🇩 Bengali</option>
            <option value="tr">🇹🇷 Turkish</option>
            <option value="vi">🇻🇳 Vietnamese</option>
            <option value="pl">🇵🇱 Polish</option>
            <option value="uk">🇺🇦 Ukrainian</option>
            <option value="fa">🇮🇷 Persian (Farsi)</option>
            <option value="nl">🇳🇱 Dutch</option>
            <option value="ta">🇮🇳 Tamil</option>
            <option value="ur">🇵🇰 Urdu</option>
            <option value="th">🇹🇭 Thai</option>
            <option value="ms">🇲🇾 Malay</option>
            <option value="sw">🇰🇪 Swahili</option>
            <option value="tl">🇵🇭 Tagalog (Filipino)</option>
            <option value="he">🇮🇱 Hebrew</option>
            <option value="ro">🇷🇴 Romanian</option>
            <option value="hu">🇭🇺 Hungarian</option>
            <option value="el">🇬🇷 Greek</option>
            <option value="cs">🇨🇿 Czech</option>
            <option value="sv">🇸🇪 Swedish</option>
            <option value="da">🇩🇰 Danish</option>
            <option value="fi">🇫🇮 Finnish</option>
            <option value="no">🇳🇴 Norwegian</option>
            <option value="id">🇮🇩 Indonesian</option>
            <option value="sr">🇷🇸 Serbian</option>
            <option value="sk">🇸🇰 Slovak</option>
            <option value="bg">🇧🇬 Bulgarian</option>
            <option value="hr">🇭🇷 Croatian</option>
            <option value="sl">🇸🇮 Slovenian</option>
            <option value="et">🇪🇪 Estonian</option>
            <option value="lv">🇱🇻 Latvian</option>
            <option value="lt">🇱🇹 Lithuanian</option>
          </select>
        </div>
        <textarea id="source-text" placeholder="Enter the original text..." dir="auto"></textarea>
        <div class="text-area-footer">
          <div id="source-lang-detected"></div>
          <div id="source-word-count" class="word-count">0 words</div>
        </div>
      </div>
    
    <button id="save-run-btn" class="btn btn-secondary save-run-btn">Save Assessment</button>
      <!-- Target text -->
      <div class="text-area-container" id="target-text-container">
        <div class="text-area-header">
          <div id="target-lang-bubble" class="language-bubble">Please select a target language</div>
          <div style="display: flex; align-items: center;">
            <label class="text-area-label" id="target-text-label">Target Text:</label>
          </div>
          <select id="target-lang">
            <option value="">-- Select Language --</option>
            <option value="en">🇬🇧 English</option>
            <option value="en-US">🇺🇸 English (US)</option>
            <option value="en-GB">🇬🇧 English (UK)</option>
            <option value="en-CA">🇨🇦 English (Canada)</option>
            <option value="en-AU">🇦🇺 English (Australia)</option>
            
            <option value="es">🇪🇸 Spanish</option>
            <option value="es-ES">🇪🇸 Spanish (Spain)</option>
            <option value="es-MX">🇲🇽 Spanish (Mexico)</option>
            <option value="es-CO">🇨🇴 Spanish (Colombia)</option>
            <option value="es-AR">🇦🇷 Spanish (Argentina)</option>
            
            <option value="fr">🇫🇷 French</option>
            <option value="fr-FR">🇫🇷 French (France)</option>
            <option value="fr-CA">🇨🇦 French (Canada)</option>
            <option value="fr-BE">🇧🇪 French (Belgium)</option>
            <option value="fr-CH">🇨🇭 French (Switzerland)</option>
            
            <option value="pt">🇵🇹 Portuguese</option>
            <option value="pt-PT">🇵🇹 Portuguese (Portugal)</option>
            <option value="pt-BR">🇧🇷 Portuguese (Brazil)</option>
            
            <option value="zh">🇨🇳 Chinese (Mandarin)</option>
            <option value="zh-CN">🇨🇳 Chinese (Simplified, China)</option>
            <option value="zh-TW">🇹🇼 Chinese (Traditional, Taiwan)</option>
            <option value="zh-HK">🇭🇰 Chinese (Traditional, Hong Kong)</option>
            <option value="zh-SG">🇸🇬 Chinese (Singapore)</option>
            
            <option value="ar">🇸🇦 Arabic</option>
            <option value="ar-SA">🇸🇦 Arabic (Saudi Arabia)</option>
            <option value="ar-EG">🇪🇬 Arabic (Egypt)</option>
            <option value="ar-AE">🇦🇪 Arabic (UAE)</option>
            <option value="ar-MA">🇲🇦 Arabic (Morocco)</option>
            
            <option value="de">🇩🇪 German</option>
            <option value="de-DE">🇩🇪 German (Germany)</option>
            <option value="de-AT">🇦🇹 German (Austria)</option>
            <option value="de-CH">🇨🇭 German (Switzerland)</option>
            
            <option value="it">🇮🇹 Italian</option>
            <option value="ja">🇯🇵 Japanese</option>
            <option value="ko">🇰🇷 Korean</option>
            <option value="ru">🇷🇺 Russian</option>
            <option value="hi">🇮🇳 Hindi</option>
            <option value="bn">🇧🇩 Bengali</option>
            <option value="tr">🇹🇷 Turkish</option>
            <option value="vi">🇻🇳 Vietnamese</option>
            <option value="pl">🇵🇱 Polish</option>
            <option value="uk">🇺🇦 Ukrainian</option>
            <option value="fa">🇮🇷 Persian (Farsi)</option>
            <option value="nl">🇳🇱 Dutch</option>
            <option value="ta">🇮🇳 Tamil</option>
            <option value="ur">🇵🇰 Urdu</option>
            <option value="th">🇹🇭 Thai</option>
            <option value="ms">🇲🇾 Malay</option>
            <option value="sw">🇰🇪 Swahili</option>
            <option value="tl">🇵🇭 Tagalog (Filipino)</option>
            <option value="he">🇮🇱 Hebrew</option>
            <option value="ro">🇷🇴 Romanian</option>
            <option value="hu">🇭🇺 Hungarian</option>
            <option value="el">🇬🇷 Greek</option>
            <option value="cs">🇨🇿 Czech</option>
            <option value="sv">🇸🇪 Swedish</option>
            <option value="da">🇩🇰 Danish</option>
            <option value="fi">🇫🇮 Finnish</option>
            <option value="no">🇳🇴 Norwegian</option>
            <option value="id">🇮🇩 Indonesian</option>
            <option value="sr">🇷🇸 Serbian</option>
            <option value="sk">🇸🇰 Slovak</option>
            <option value="bg">🇧🇬 Bulgarian</option>
            <option value="hr">🇭🇷 Croatian</option>
            <option value="sl">🇸🇮 Slovenian</option>
            <option value="et">🇪🇪 Estonian</option>
            <option value="lv">🇱🇻 Latvian</option>
            <option value="lt">🇱🇹 Lithuanian</option>            
          </select>
        </div>
        <textarea id="target-text" placeholder="Enter the translated text..." dir="auto"></textarea>
        <div class="text-area-footer">
          <div></div>
          <div style="display: flex; flex-direction: column; align-items: flex-end;">
            <div id="target-word-count" class="word-count">0 words</div>
            <button id="translate-btn" class="btn translate-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="translate-btn-icon">
                <path d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286H4.545zm1.634-.736L5.5 3.956h-.049l-.679 2.022H6.18z"/>
                <path d="M0 2a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v3h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2zm7.138 9.995c.193.301.402.583.63.846-.748.575-1.673 1.001-2.768 1.292.178.217.451.635.555.867 1.125-.359 2.08-.844 2.886-1.494.777.665 1.739 1.165 2.93 1.472.133-.254.414-.673.629-.89-1.125-.253-2.057-.694-2.82-1.284.681-.747 1.222-1.651 1.621-2.757H14V8h-3v1.059h.5c.412 0 .743.337.743.75 0 .413-.331.75-.743.75h-1.5a.75.75 0 0 1-.75-.75V9.5a.75.75 0 0 1 .75-.75h.5V8h-1.5a.75.75 0 0 1-.75-.75V7.5a.75.75 0 0 1 .75-.75h3.5c.409 0 .74.336.74.75 0 .413-.331.75-.74.75h-1.5v.056c-.319.975-.71 1.769-1.225 2.425.556.665 1.257 1.197 2.121 1.596.22-.208.498-.634.704-.889-.914-.344-1.632-.788-2.202-1.37a.75.75 0 0 1-.174-.144c.002-.002.005-.006.007-.008Z"/>
              </svg>
              Translate
            </button>
            <div id="translation-engine-info" class="translation-engine-info" style="font-size: 11px; margin-top: 4px; text-align: center; width: 100%;"></div>
          </div>
        </div>
      </div>
    </div>
  <!-- Authentication and Account Management Modals -->
  
  <!-- Login Modal -->
  <div id="login-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Log In</h2>
        <button class="close">&times;</button>
      </div>
      <form id="login-form">
        <div class="form-group">
          <label for="login-email" class="form-label">Email</label>
          <input type="email" id="login-email" required placeholder="Enter your email">
        </div>
        <div class="form-group">
          <label for="login-password">Password</label>
          <input type="password" id="login-password" required>
          <div style="text-align: right; margin-top: 5px;">
            <a href="#" id="forgot-password-link" class="text-sm text-blue-500 hover:text-blue-700">Forgot Password?</a>
          </div>
        </div>
        <div id="login-error" class="form-error"></div>
        <div class="buttons mt-4">
          <button type="submit" class="btn btn-primary">Log In</button>
        </div>
        <div class="text-center mt-4">
          <p>Don't have an account? <a href="#" onclick="hideModal(loginModal); showRegisterModal(); return false;">Register</a></p>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Forgot Password Modal -->
  <div id="forgot-password-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Reset Password</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <form id="forgot-password-form">
          <div class="form-group">
            <label for="forgot-email">Email Address</label>
            <input type="email" id="forgot-email" required>
            <p class="form-help">Enter the email address associated with your account.</p>
          </div>
          <div id="forgot-password-error" class="form-error"></div>
          <div id="forgot-password-success" class="form-success forgot-password-success">
            Password reset email sent. Please check your inbox.
          </div>
          <div class="buttons mt-4">
            <button type="submit" class="btn btn-primary">Send Reset Link</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Register Modal -->
  <div id="register-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Create an Account</h2>
        <span class="close">&times;</span>
      </div>
      <form id="register-form">
        <div class="form-group">
          <label for="register-email" class="form-label">Email</label>
          <input type="email" id="register-email" required placeholder="Enter your email">
        </div>
        <div class="form-group">
          <label for="register-password" class="form-label">Password</label>
          <input type="password" id="register-password" required placeholder="Create a password">
        </div>
        <div class="form-group">
          <label for="register-confirm-password" class="form-label">Confirm Password</label>
          <input type="password" id="register-confirm-password" required placeholder="Confirm your password">
        </div>
        <div id="register-error" class="form-error"></div>
        <div class="buttons mt-4">
          <button type="submit" class="btn btn-primary">Register</button>
        </div>
        <div class="text-center mt-4">
          <p>Already have an account? <a href="#" onclick="hideModal(registerModal); showLoginModal(); return false;">Log In</a></p>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Account Modal -->
  <div id="account-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Account Settings</h2>
        <button class="close-modal">&times;</button>
      </div>
      <div class="p-4">
        <div class="mb-4">
          <h3 class="text-lg font-semibold mb-2">Account Information</h3>
          <div class="bg-accent p-4 rounded-md">
            <p><strong>Email:</strong> <span id="account-email">user@example.com</span></p>
            <p><strong>Account Type:</strong> <span id="account-type">Free</span></p>
            <p><strong>Usage:</strong> <span id="account-usage">0 of 25 runs</span></p>
          </div>
        </div>
        
        <div class="mb-4">
          <h3 class="text-lg font-semibold mb-2">Profile Settings</h3>
          <div class="bg-accent p-4 rounded-md">
            <form id="profile-form" class="space-y-3">
              <div class="form-group">
                <label for="profile-name">Display Name</label>
                <input type="text" id="profile-name" class="form-control" placeholder="Your name">
              </div>
              
              <div class="form-group">
                <label for="profile-current-password">Current Password</label>
                <input type="password" id="profile-current-password" class="form-control" placeholder="Current password">
              </div>
              
              <div class="form-group">
                <label for="profile-new-password">New Password</label>
                <input type="password" id="profile-new-password" class="form-control" placeholder="New password">
              </div>
              
              <div class="form-group">
                <label for="profile-confirm-password">Confirm New Password</label>
                <input type="password" id="profile-confirm-password" class="form-control" placeholder="Confirm new password">
              </div>
              
              <div class="form-group">
                <p id="profile-error" class="text-error"></p>
                <p id="profile-success" class="text-success"></p>
              </div>
              
              <button type="submit" class="btn btn-primary">Update Profile</button>
            </form>
          </div>
        </div>
        
        <div class="mb-4">
          <h3 class="text-lg font-semibold mb-2">Subscription</h3>
          <p class="mb-2">Upgrade to a paid plan for unlimited assessments.</p>
          <button id="upgrade-btn" class="btn btn-primary" onclick="showSubscriptionModal(); hideModal(document.getElementById('account-modal'));">Upgrade Now</button>
        </div>
        
        <div class="mb-4">
          <h3 class="text-lg font-semibold mb-2">Account Actions</h3>
          <div class="flex gap-2">
            <button class="btn btn-secondary" onclick="showDashboardModal(); hideModal(document.getElementById('account-modal'));">View Saved Assessments</button>
            <button class="btn btn-secondary" onclick="logout();">Log Out</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Dashboard Modal -->
  <div id="dashboard-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Your Assessments</h2>
        <button class="close-modal">&times;</button>
      </div>
      
      <div class="dashboard-tabs">
        <div class="dashboard-tab active" data-tab="saved">Saved Assessments</div>
        <div class="dashboard-tab" data-tab="recent">Recent Activity</div>
      </div>
      
      <div class="dashboard-content">
        <div id="saved-runs-container">
          <!-- Saved runs will be loaded here -->
          <p class="text-center mt-4">Loading your assessments...</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Subscription Modal -->
  <div id="subscription-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Choose a Plan</h2>
        <button class="close-modal">&times;</button>
      </div>
      <form id="subscription-form">
        <div class="subscription-plans">
          <div class="plan-option" onclick="document.getElementById('plan-free').checked = true;">
            <div class="plan-header">
              <input type="radio" name="subscription-plan" id="plan-free" value="free" class="plan-radio" checked>
              <div class="plan-details">
                <div class="plan-name">Free</div>
                <div class="plan-price">$0/month</div>
              </div>
            </div>
            <div class="plan-features">
              <div class="plan-feature">
                <span class="feature-icon">✓</span>
                <span>25 MQM assessments per month</span>
              </div>
              <div class="plan-feature">
                <span class="feature-icon">✓</span>
                <span>Basic report exports</span>
              </div>
              <div class="plan-feature">
                <span class="feature-icon">✓</span>
                <span>Community support</span>
              </div>
            </div>
          </div>
          
          <div class="plan-option" onclick="document.getElementById('plan-premium').checked = true;">
            <div class="plan-header">
              <input type="radio" name="subscription-plan" id="plan-premium" value="premium" class="plan-radio">
              <div class="plan-details">
                <div class="plan-name">Premium</div>
                <div class="plan-price">$29/month</div>
              </div>
            </div>
            <div class="plan-features">
              <div class="plan-feature">
                <span class="feature-icon">✓</span>
                <span>Unlimited MQM assessments</span>
              </div>
              <div class="plan-feature">
                <span class="feature-icon">✓</span>
                <span>Advanced report exports</span>
              </div>
              <div class="plan-feature">
                <span class="feature-icon">✓</span>
                <span>Priority support</span>
              </div>
              <div class="plan-feature">
                <span class="feature-icon">✓</span>
                <span>API access</span>
              </div>
            </div>
          </div>
        </div>
        
        <div id="card-section" class="card-section">
          <div id="card-element"></div>
          <div id="card-errors" class="form-error"></div>
        </div>
        
        <div id="subscription-error" class="form-error"></div>
        
        <div class="buttons mt-4">
          <button type="submit" class="btn btn-primary">Subscribe</button>
          <button type="button" class="btn btn-secondary" onclick="hideModal(subscriptionModal);">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Admin Modal -->
  <div id="admin-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Admin Dashboard</h2>
        <button class="close-modal">&times;</button>
      </div>
      
      <div class="dashboard-tabs">
        <div class="dashboard-tab active" data-tab="users">Users</div>
        <div class="dashboard-tab" data-tab="stats">Statistics</div>
      </div>
      
      <div class="dashboard-content">
        <div id="admin-users-list">
          <!-- User list will be loaded here -->
          <p class="text-center mt-4">Loading users...</p>
        </div>
      </div>
    </div>
  </div>
    <!-- File Upload Section -->
    <div class="excel-section">
      <h3 class="gothic-title excel-section-title">Translation File Upload</h3>
      <p class="excel-section-description">
        Upload your translation files for assessment. We support the following formats:
        <ul class="excel-section-list">
          <li>TMX (Translation Memory eXchange)</li>
          <li>XLIFF (XML Localization Interchange File Format)</li>
          <li>Excel spreadsheets (.xlsx) with source and target columns</li>
        </ul>
        <span class="excel-section-note">Note: File upload currently works for bilingual translations only.</span>
        <span class="excel-section-info">If you don't have TMX or XLIFF files, you can download our Excel template below, fill it with your translations, and upload it for assessment.</span>
      </p>
      
      <!-- Download Template Button -->
      <div style="margin-bottom: 15px;">
        <button id="download-template-btn" class="btn btn-secondary">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 8px; vertical-align: text-bottom;">
            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
          </svg>
          Download Excel Template
        </button>
      </div>
      
      <!-- Upload Form -->
      <form id="excel-upload-form">
        <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 10px;">
          <input type="file" id="excel-file-input" style="display: none;" accept=".xlsx,.xliff,.xlf,.tmx">
          <button type="button" id="excel-file-select-btn" class="btn btn-secondary" style="flex-grow: 0;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 8px; vertical-align: text-bottom;">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
              <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
            Select Translation File
          </button>
          <span id="selected-file-info" style="color: var(--text-muted); flex-grow: 1;"></span>
          <button type="submit" id="excel-upload-btn" class="btn btn-primary" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 8px; vertical-align: text-bottom;">
              <path d="M.5 3a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h15a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5H.5zm1.5.5A.5.5 0 0 1 2.5 3h11a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5v-1z"/>
            </svg>
            Upload & Analyze
          </button>
        </div>
        <!-- Upload Status -->
        <div id="excel-upload-status" style="display: none; padding: 10px; border-radius: 6px; margin-top: 10px;"></div>
      </form>
    </div>
    
    <details class="faq-item" style="margin-bottom: 20px;">
      <summary style="font-size: 16px; font-weight: 500; color: #ff6c36; cursor: pointer;">What are the account limits?</summary>
      <p style="font-size: 14px; color: #a0a0a0; margin-top: 10px;">
        Anonymous users can run up to 5 assessments, free accounts get 25 assessments per month, and paid accounts have unlimited access.
        All accounts can save and export their assessments.
      </p>
    </details>
    <!-- Target text display (for highlighting issues) - This is initially hidden -->
    <div id="target-display-container" style="display: none;">
      <div class="text-area-header">
        <label class="text-area-label">Target Text with Issues Highlighted:</label>
      </div>
      <div id="target-display"></div>
    </div>
<!-- Corrected text output - This is initially hidden -->
<div class="corrected-text-container" id="corrected-text-container" style="display: none;">
    <div class="corrected-text-header">
      <label class="corrected-text-label">Corrected Text:</label>
      <button id="copy-btn" class="btn copy-btn">Copy to Clipboard</button>
    </div>
    <textarea id="corrected-text"></textarea>
    <div class="text-area-footer">
      <div id="correction-status" class="correction-status">✏️ You can edit this text to refine corrections</div>
    </div>
  </div>

  <!-- Buttons -->
  <div class="buttons">
    <button id="analyze-btn" class="btn btn-primary" disabled>🔍 Run Quality Check</button>
    <button id="reset-btn" class="btn btn-secondary">🔄 Reset</button>
    <button id="apply-all-btn" class="btn btn-primary" style="display: none;">✨ Apply All</button>
    <button id="undo-btn" class="btn btn-secondary" style="display: none;" disabled>↩️ Undo Last</button>
    <button id="toggle-rejected-btn" class="btn btn-secondary" style="display: none;">👁️ Show Rejected Issues</button>
  </div>

  <div class="buttons" id="download-buttons" style="display: none;">
    <button id="download-excel-btn" class="btn btn-secondary">Download Quality Report</button>
  </div>
  
  <!-- Error message (initially hidden) -->
  <div id="error-message" class="error-message" style="display: none;"></div>
  
  <!-- Notification container for success/info messages -->
  <div id="notification-container" class="notification-container"></div>
  
  <style>
    /* Spinner for loading states */
    .spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Notification system */
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 350px;
    }
    
    .notification {
      padding: 12px 15px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: space-between;
      animation: slide-in 0.3s ease-out forwards;
      font-size: 14px;
    }
    
    .notification.success {
      background-color: rgba(46, 204, 113, 0.2);
      border: 1px solid rgba(46, 204, 113, 0.3);
      color: var(--success-green);
    }
    
    .notification.info {
      background-color: rgba(52, 152, 219, 0.2);
      border: 1px solid rgba(52, 152, 219, 0.3);
      color: var(--brand-blue);
    }
    
    .notification.warning {
      background-color: rgba(241, 196, 15, 0.2);
      border: 1px solid rgba(241, 196, 15, 0.3);
      color: var(--warning-yellow);
    }
    
    .notification.error {
      background-color: rgba(231, 76, 60, 0.2);
      border: 1px solid rgba(231, 76, 60, 0.3);
      color: var(--danger-red);
    }
    
    .notification-close {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      margin-left: 10px;
      opacity: 0.7;
      font-size: 16px;
    }
    
    .notification-close:hover {
      opacity: 1;
    }
    
    @keyframes slide-in {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes fade-out {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  </style>

  <!-- Results (initially hidden) -->
  <div id="results-container" style="display: none;">
    <div class="results">
      <div class="results-header">
        <div class="results-title-row">
          <h2 class="results-title gothic-title">Quality Check Results</h2>
          <div class="score-container">
            <span id="score" class="score">0.0</span>
            <div id="score-indicator" class="score-indicator success">✓</div>
            <div class="score-formula">
              <p><strong>Score Formula:</strong></p>
              <p>Score = 100 - (Total Error Points / Word Count × 100)</p>
              <p>Error Points: Minor = 1, Major = 5, Critical = 10</p>
            </div>
          </div>
        </div>
        <p id="summary" class="summary"></p>
        <div id="categories" class="categories">
          <!-- Categories will be added here -->
        </div>
      </div>
      
      <div id="issues-container">
        <!-- Issues will be added here -->
      </div>
    </div>
  </div>

  <!-- Tooltip element for showing issue details on hover -->
  <div id="tooltip" class="tooltip"></div>

<!-- FAQ Section -->
<section id="faq" class="faq-section" style="margin-top: 40px;">
    <h2 class="gothic-title" style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: #ffffff;">Frequently Asked Questions</h2>
  
    <!-- First question expanded by default -->
    <div class="faq-item" style="margin-bottom: 20px;">
      <h3 class="gothic-title" style="font-size: 18px; font-weight: 600; color: #ff6c36;">What is MQM and how does FastFin use it?</h3>
      <p style="font-size: 14px; color: #a0a0a0;">MQM (Multidimensional Quality Metrics) is an industry-standard framework for evaluating translation quality. FastFin uses advanced AI to apply MQM principles, automatically detecting issues like mistranslations, fluency problems, and terminology errors. The framework provides a structured approach to categorize and score translation issues, allowing for consistent quality assessment across different languages and content types. Each identified issue is assigned a severity level (minor, major, or critical) which contributes to the overall quality score.</p>
    </div>

    <!-- Remaining questions collapsible -->
    <details class="faq-item" style="margin-bottom: 20px;">
      <summary class="gothic-title" style="font-size: 18px; font-weight: 600; color: #ff6c36; cursor: pointer;">What's the difference between Bilingual and Monolingual modes?</summary>
      <p style="font-size: 14px; color: #a0a0a0; margin-top: 10px;">In Bilingual mode, FastFin compares source and target texts to identify translation-specific issues like mistranslations, omissions, or additions. This is ideal for evaluating translation accuracy. Monolingual mode focuses solely on the target text quality, analyzing fluency, grammar, and style without requiring source text. This is useful for evaluating standalone content or when source text isn't available.</p>
    </details>

    <details class="faq-item" style="margin-bottom: 20px;">
      <summary class="gothic-title" style="font-size: 18px; font-weight: 600; color: #ff6c36; cursor: pointer;">How does the automated translation assessment work?</summary>
      <p style="font-size: 14px; color: #a0a0a0; margin-top: 10px; font-family: 'Inter', sans-serif;">Our automated translation assessment uses the Multidimensional Quality Metrics (MQM) framework implemented through advanced AI models (Claude 3 family). The system is calibrated on thousands of professional translations across multiple industries and language pairs. It evaluates translations based on several dimensions:</p>
        <ul style="margin-top: 8px; margin-left: 20px; color: #a0a0a0; font-size: 14px; font-family: 'Inter', sans-serif;">
          <li><strong>Accuracy:</strong> Detecting mistranslations, omissions, additions, and untranslated content</li>
          <li><strong>Fluency:</strong> Evaluating grammar, spelling, punctuation, and typography</li>
          <li><strong>Terminology:</strong> Checking for consistent and appropriate terminology use</li>
          <li><strong>Style:</strong> Identifying awkward phrasing and cultural adaptation issues</li>
          <li><strong>Design:</strong> Assessing text length and markup/code elements</li>
        </ul>
        <p style="font-size: 14px; color: #a0a0a0; margin-top: 8px; font-family: 'Inter', sans-serif;">Each issue is assigned a severity level (minor, major, or critical) which contributes to the overall quality score. The system has been benchmarked against human evaluators and achieves high correlation with professional reviewers.
      </p>
    </details>

    <details class="faq-item" style="margin-bottom: 20px;">
      <summary class="gothic-title" style="font-size: 18px; font-weight: 600; color: #ff6c36; cursor: pointer;">How accurate is FastFin's assessment?</summary>
      <p style="font-size: 14px; color: #a0a0a0; margin-top: 10px;">FastFin uses state-of-the-art AI models (Claude 3 family) specifically fine-tuned for translation quality assessment. While no automated system is perfect, FastFin achieves high correlation with human reviewers, especially for technical and professional content. The system continuously improves through machine learning. For critical content requiring regulatory compliance, we recommend using FastFin as a first-pass assessment followed by targeted human review.</p>
    </details>

    <details class="faq-item" style="margin-bottom: 20px;">
      <summary class="gothic-title" style="font-size: 18px; font-weight: 600; color: #ff6c36; cursor: pointer;">Which languages does FastFin support?</summary>
      <p style="font-size: 14px; color: #a0a0a0; margin-top: 10px;">FastFin supports over 100 languages, including all major European, Asian, and Middle Eastern languages. The system has built-in support for right-to-left (RTL) languages like Arabic, Hebrew, and Persian. Language-specific rules are applied to ensure culturally and linguistically appropriate assessments for each language pair.</p>
    </details>

    <details class="faq-item" style="margin-bottom: 20px;">
      <summary class="gothic-title" style="font-size: 18px; font-weight: 600; color: #ff6c36; cursor: pointer;">How does the Excel integration work?</summary>
      <p style="font-size: 14px; color: #a0a0a0; margin-top: 10px;">FastFin's Excel integration allows you to work with translations offline and in batch. Download our template, fill in your source and target texts along with language information, and optionally add your own annotations. When uploaded, FastFin processes the entire file, applying MQM analysis to each entry and generating a comprehensive report that you can download or view online.</p>
    </details>

    <details class="faq-item" style="margin-bottom: 20px;">
      <summary class="gothic-title" style="font-size: 18px; font-weight: 600; color: #ff6c36; cursor: pointer;">How is my data handled?</summary>
      <p style="font-size: 14px; color: #a0a0a0; margin-top: 10px;">FastFin prioritizes data security and privacy. Your translations are processed securely and are not used to train our models. For registered users, assessment results are stored in your account for your reference, but you can delete them at any time. Anonymous sessions store minimal data using temporary cookies. For enterprise clients, we offer dedicated deployments with enhanced security protocols.</p>
    </details>
  </section>
  
  <!-- FAQ Schema Markup -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
      {
        "@type": "Question",
        "name": "What is MQM and how does this tool use it?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "MQM (Multidimensional Quality Metrics) is an industry-standard framework for evaluating translation quality. This tool automatically detects issues like mistranslations, fluency problems, and terminology errors using MQM categories."
        }
      },
      {
        "@type": "Question",
        "name": "How accurate is the analysis?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "The tool uses a combination of LLMs and linguistic rules to provide reliable assessments. While it's not a substitute for a human reviewer in critical cases, it's highly effective for scalable QA and triage."
        }
      },
      {
        "@type": "Question",
        "name": "Can I use this for regulatory or medical content?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Yes, the tool supports high-stakes content. However, we recommend using it as a pre-QA step before final human validation for regulatory texts."
        }
      },
      {
        "@type": "Question",
        "name": "Does this integrate with my CAT tool or TMS?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Not yet, but we’re actively building integrations. Let us know which tools you’d like us to support first."
        }
      },
      {
        "@type": "Question",
        "name": "How do you handle data privacy?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Your data is never stored or reused. We process inputs securely and ensure that no text is saved after the session ends."
        }
      }
    ]
  }
  </script>
  
  <!-- Footer -->
  <div class="footer">
    © 2025 Orca Language Solutions. All rights reserved. | <a href="javascript:void(0)" onclick="showLoginModal();">Log In</a> | <a href="javascript:void(0)" onclick="showRegisterModal();">Register</a>
  </div>
</div>

<script>
  // Get DOM elements
  const sourceText = document.getElementById('source-text');
  const targetText = document.getElementById('target-text');
  const sourceLang = document.getElementById('source-lang');
  const targetLang = document.getElementById('target-lang');
  const saveRunBtn = document.getElementById('save-run-btn');
  const downloadTemplateBtn = document.getElementById('download-template-btn');
  const loginBtn = document.getElementById('login-btn');
  const registerBtn = document.getElementById('register-btn');
  const excelFileInput = document.getElementById('excel-file-input');
  const excelFileSelectBtn = document.getElementById('excel-file-select-btn');
  const excelUploadBtn = document.getElementById('excel-upload-btn');
  const excelUploadForm = document.getElementById('excel-upload-form');
  const selectedFileInfo = document.getElementById('selected-file-info');
  const excelUploadStatus = document.getElementById('excel-upload-status');
  const sourceLangDetected = document.getElementById('source-lang-detected');
  const targetLangDetected = document.getElementById('target-lang-detected');
  const wordCount = document.getElementById('word-count');
  const analyzeBtn = document.getElementById('analyze-btn');
  const resetBtn = document.getElementById('reset-btn');
  const applyAllBtn = document.getElementById('apply-all-btn');
  const errorMessage = document.getElementById('error-message');
  const resultsContainer = document.getElementById('results-container');
  const score = document.getElementById('score');
  const scoreIndicator = document.getElementById('score-indicator');
  const summary = document.getElementById('summary');
  const categories = document.getElementById('categories');
  const issuesContainer = document.getElementById('issues-container');
  const targetDisplayContainer = document.getElementById('target-display-container');
  const targetDisplay = document.getElementById('target-display');
  const correctedTextContainer = document.getElementById('corrected-text-container');
  const correctedText = document.getElementById('corrected-text');
  const copyBtn = document.getElementById('copy-btn');
  const tooltip = document.getElementById('tooltip');
  const undoBtn = document.getElementById('undo-btn');
  // Initialize current run ID
  let currentRunId = null;
  // Word count limit
  const WORD_COUNT_LIMIT = 500;
  let isOverLimit = false;
    saveRunBtn.style.display = 'none';
  // Severity levels
  const severityLevels = {
    MINOR: { label: 'Minor', value: 1, class: 'minor' },
    MAJOR: { label: 'Major', value: 5, class: 'major' },
    CRITICAL: { label: 'Critical', value: 10, class: 'critical' }
  };
    currentRunId = null;
  // Store issues, text segments, and corrections
  let currentIssues = [];
  let issueToSegmentMap = {};
  let appliedCorrections = {};
  let currentTargetText = '';
  let changeHistory = [];
  // Update word count
  function updateWordCountDisplay() {
    // Check if we're in monolingual mode
    const isMonolingual = document.getElementById('translation-mode-toggle').checked;
    
    // Get text from the appropriate field based on mode
    const text = isMonolingual ? targetText.value.trim() : sourceText.value.trim();
    const words = text.length > 0 ? text.split(/\s+/) : [];
    const count = words.length;
    
    isOverLimit = count > WORD_COUNT_LIMIT;
    wordCount.textContent = `${count} / ${WORD_COUNT_LIMIT} words${isOverLimit ? ' (limit exceeded)' : ''}`;
    
    if (isOverLimit) {
        wordCount.classList.add('word-count-exceeded');
        // Highlight the appropriate text area based on mode
        if (isMonolingual) {
            targetText.style.borderColor = '#ff6b6b';
        } else {
            sourceText.style.borderColor = '#ff6b6b';
        }
    } else {
        wordCount.classList.remove('word-count-exceeded');
        sourceText.style.borderColor = 'rgb(60, 60, 60)';
        targetText.style.borderColor = 'rgb(60, 60, 60)';
    }

    updateAnalyzeButton();
  }

  // Event listeners for sourceText
  sourceText.addEventListener('input', function() {
    updateWordCountDisplay();
    handleSourceLanguageDetection();
  });
  
  sourceText.addEventListener('paste', function() {
    setTimeout(function() {
      updateWordCountDisplay();
      handleSourceLanguageDetection();
    }, 10);
  });

  // Event listeners for targetText
  targetText.addEventListener('input', function() {
    handleTargetLanguageDetection();
    updateWordCountDisplay(); // Update word count when target text changes
    updateAnalyzeButton();
  });
  
  targetText.addEventListener('paste', function() {
    setTimeout(function() {
      handleTargetLanguageDetection();
      updateWordCountDisplay(); // Update word count when target text is pasted
      updateAnalyzeButton();
    }, 10);
  });
  
  // Add event listener for translation mode toggle
  document.getElementById('translation-mode-toggle').addEventListener('change', function() {
    updateWordCountDisplay();
    // The toggleMonolingualMode function is defined elsewhere and already being called
  });

  // Language detection API function
  async function detectLanguage(text) {
    try {
      // For development/testing without backend
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return simulateLanguageDetection(text);
      }
      
      const response = await fetch('/api/detect-language', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ text })
      });
      
      if (!response.ok) {
        throw new Error('Language detection failed');
      }
      
      const data = await response.json();
      return data.detectedLanguage;
    } catch (error) {
      console.error('Error detecting language:', error);
      // Fallback to client-side detection
      return simulateLanguageDetection(text);
    }
  }

  // Simulate language detection for testing or fallback
  function simulateLanguageDetection(text) {
    return new Promise((resolve) => {
      setTimeout(() => {
        // A very simplified detection based on character patterns
        const sample = text.slice(0, 50).toLowerCase();
        
        // Check for language patterns
        if (/[áéíóúüñ¿¡]/.test(sample)) resolve('es');
        else if (/[àâçéèêëîïôùûüÿ]/.test(sample)) resolve('fr');
        else if (/[äöüß]/.test(sample)) resolve('de');
        else if (/[\u4e00-\u9fff]/.test(sample)) resolve('zh');
        else if (/[\u3040-\u30ff]/.test(sample)) resolve('ja');
        else if (/[\uAC00-\uD7AF]/.test(sample)) resolve('ko');
        else if (/[\u0400-\u04FF]/.test(sample)) resolve('ru');
        else if (/[\u0627-\u064A]/.test(sample)) resolve('ar');
        else if (/[\u0905-\u0939]/.test(sample)) resolve('hi');
        else resolve('en'); // Default to English
      }, 500);
    });
  }

  // Update source language detection
  function handleSourceLanguageDetection() {
    if (sourceText.value.length >= 10 && !sourceLang.value) {
      sourceLangDetected.textContent = 'Detecting...';
      detectLanguage(sourceText.value).then(detectedLang => {
        if (detectedLang) {
          sourceLang.value = detectedLang;
          const flag = getLanguageFlag(detectedLang);
          const name = getLanguageName(detectedLang);
          sourceLangDetected.textContent = `Detected: ${flag} ${name}`;
          updateAnalyzeButton();
        }
      });
    }
    updateAnalyzeButton();
  }

  // Update target language detection
  function handleTargetLanguageDetection() {
    if (targetText.value.length >= 10 && !targetLang.value) {
      targetLangDetected.textContent = 'Detecting...';
      detectLanguage(targetText.value).then(detectedLang => {
        if (detectedLang) {
          targetLang.value = detectedLang;
          const flag = getLanguageFlag(detectedLang);
          const name = getLanguageName(detectedLang);
          targetLangDetected.textContent = `Detected: ${flag} ${name}`;
          updateAnalyzeButton();
        }
      });
    }
    updateAnalyzeButton();
  }

  // Determine which translation engine will be used based on selected languages
  function getTranslationEngine(sourceLang, targetLang) {
    if (!sourceLang || !targetLang) return null;
    
    // Get base language codes (e.g., 'en' from 'en-US')
    const sourceBase = sourceLang.split('-')[0];
    const targetBase = targetLang.split('-')[0];
    
    // DeepL supported languages (keep in sync with server.js)
    const deeplSupportedLanguages = [
      'bg', 'cs', 'da', 'de', 'el', 'en', 'es', 'et', 'fi', 'fr', 'hu', 'id',
      'it', 'ja', 'ko', 'lt', 'lv', 'nb', 'nl', 'pl', 'pt', 'ro', 'ru', 'sk',
      'sl', 'sv', 'tr', 'uk', 'zh'
    ];
    
    // Check if both source and target languages are supported by DeepL
    if (deeplSupportedLanguages.includes(sourceBase) && deeplSupportedLanguages.includes(targetBase)) {
      return 'DeepL';
    }
    
    // Google Translate supports most languages
    return 'Google Translate';
    
    // Note: Claude fallback is not shown here since it's only used if both DeepL and Google fail
  }
  
  // Hide language bubble when target language is selected
  targetLang.addEventListener('change', function() {
    const targetLangBubble = document.getElementById('target-lang-bubble');
    if (targetLang.value && targetLangBubble) {
      targetLangBubble.style.display = 'none';
    }
  });

  // Update language display when selected manually
  sourceLang.addEventListener('change', function() {
    if (sourceLang.value) {
      const flag = getLanguageFlag(sourceLang.value);
      const name = getLanguageName(sourceLang.value);
      sourceLangDetected.textContent = `Selected: ${flag} ${name}`;
      
      // Update translation engine info if both languages are selected
      updateTranslationEngineInfo();
    } else {
      sourceLangDetected.textContent = '';
    }
    
    updateAnalyzeButton();
  });

  targetLang.addEventListener('change', function() {
    if (targetLang.value) {
      const flag = getLanguageFlag(targetLang.value);
      const name = getLanguageName(targetLang.value);
      targetLangDetected.textContent = `Selected: ${flag} ${name}`;
      
      // Update translation engine info if both languages are selected
      updateTranslationEngineInfo();
    } else {
      targetLangDetected.textContent = '';
    }

    updateAnalyzeButton();
  });

  // Get the translation engine info element
  const translationEngineInfo = document.getElementById('translation-engine-info');
  
  // Function to update the translation engine info based on selected languages
  function updateTranslationEngineInfo() {
    if (sourceLang.value && targetLang.value) {
      const engine = getTranslationEngine(sourceLang.value, targetLang.value);
      if (engine) {
        translationEngineInfo.textContent = `Translation via: ${engine}`;
        translationEngineInfo.style.display = 'block';
      } else {
        translationEngineInfo.style.display = 'none';
      }
    } else {
      translationEngineInfo.style.display = 'none';
    }
  }

  // Update analyze button state based on form completeness
  function updateAnalyzeButton() {
    const isMonolingual = document.getElementById('translation-mode-toggle').checked;
    console.log('Updating analyze button, isMonolingual:', isMonolingual);
    
    if (isMonolingual) {
      analyzeBtn.disabled = !targetText.value || !targetLang.value || isOverLimit;
    } else {
      analyzeBtn.disabled = !sourceText.value || !targetText.value || !sourceLang.value || !targetLang.value || isOverLimit;
    }
  }
  
  // Listen for translation mode changes
  document.addEventListener('translation-mode-changed', updateAnalyzeButton);

  // Machine Translation functionality
  const translateBtn = document.getElementById('translate-btn');
  // Create a function to show target language error specifically under the dropdown
  function showTargetLangError(message) {
    // Create error element if it doesn't exist
    let targetLangError = document.getElementById('target-lang-error');
    if (!targetLangError) {
      targetLangError = document.createElement('div');
      targetLangError.id = 'target-lang-error';
      targetLangError.style.display = 'none';
      targetLangError.style.color = '#721c24';
      targetLangError.style.backgroundColor = '#f8d7da';
      targetLangError.style.padding = '5px';
      targetLangError.style.borderRadius = '4px';
      targetLangError.style.marginTop = '5px';
      targetLangError.style.fontSize = '12px';
      targetLangError.style.fontWeight = 'bold';
      
      // Insert after target language dropdown
      const targetLangSelect = document.getElementById('target-lang');
      targetLangSelect.parentNode.insertBefore(targetLangError, targetLangSelect.nextSibling);
    }
    
    // Show the error message
    targetLangError.textContent = message;
    targetLangError.style.display = 'block';
    
    // Hide after 5 seconds
    setTimeout(() => {
      targetLangError.style.display = 'none';
    }, 5000);
  }

  translateBtn.addEventListener('click', async () => {
    // Clear any previous error messages
    const targetLangError = document.getElementById('target-lang-error');
    if (targetLangError) targetLangError.style.display = 'none';
    
    // Hide the bubble if it's visible
    const targetLangBubble = document.getElementById('target-lang-bubble');
    if (targetLangBubble) targetLangBubble.style.display = 'none';
    
    // Check if we have source text and languages selected
    if (!sourceText.value) {
      showError('Please enter source text to translate');
      return;
    }
    
    if (!sourceLang.value) {
      showError('Please select a source language');
      return;
    }
    
    if (!targetLang.value) {
      // Show ONLY the target language bubble (not the error message)
      if (targetLangBubble) {
        targetLangBubble.style.display = 'block';
        // Make it pulse to draw attention
        targetLangBubble.classList.add('pulse');
        // Remove the pulse class after the animation completes
        setTimeout(() => {
          targetLangBubble.classList.remove('pulse');
        }, 1000);
      }
      return;
    }
    
    // Ensure we're in bilingual mode for translation
    if (document.getElementById('translation-mode-toggle').checked) {
      // We're in monolingual mode, switch to bilingual
      document.getElementById('translation-mode-toggle').checked = false;
      toggleSourceTextVisibility(false);
      showNotification('Switched to bilingual mode for translation', 'info');
    }
    
    // Show loading state
    translateBtn.disabled = true;
    translateBtn.innerHTML = '<span class="spinner"></span> Translating...';
    targetText.value = 'Translating...';
    
    try {
      const response = await fetch('/api/translate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          text: sourceText.value,
          sourceLang: sourceLang.value,
          targetLang: targetLang.value
        })
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || data.message || 'Translation failed');
      }
      
      // Update target text with translation
      targetText.value = data.translatedText;
      
      // Show success notification
      showNotification(`Translation completed using ${data.engine} engine`, 'success');
      
      // Update translation engine info with the actually used engine
      translationEngineInfo.textContent = `Translation via: ${data.engine}`;
      translationEngineInfo.style.display = 'block';
      
      // Update analyze button state
      updateAnalyzeButton();
      
    } catch (error) {
      console.error('Translation error:', error);
      showError(error.message || 'Translation failed. Please try again.');
      targetText.value = '';
    } finally {
      // Reset button state
      translateBtn.disabled = false;
      translateBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: text-bottom;">
        <path d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286H4.545zm1.634-.736L5.5 3.956h-.049l-.679 2.022H6.18z"/>
        <path d="M0 2a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v3h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2zm7.138 9.995c.193.301.402.583.63.846-.748.575-1.673 1.001-2.768 1.292.178.217.451.635.555.867 1.125-.359 2.08-.844 2.886-1.494.777.665 1.739 1.165 2.93 1.472.133-.254.414-.673.629-.89-1.125-.253-2.057-.694-2.82-1.284.681-.747 1.222-1.651 1.621-2.757H14V8h-3v1.059h.5c.412 0 .74.337.74.75v.5h-.739c-.4-1.023-.918-1.805-1.541-2.543-.473.605-.914 1.173-1.284 1.729-.687-.524-1.063-1.109-1.466-1.729H5.5V7.5h2v-1H5.5V6h6V5h-2.5c-.1-.445-.324-1.775-1.5-2.5C7.146 4.013 6.773 5.111 6.5 6H4v1h1.5v.5H4v1h1.5v.5H5c-.177 0-.335.077-.442.235z"/>
      </svg>
      Translate`;
    }
  });

  // Helper function to escape special characters in regular expressions
  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  // Reset everything
  resetBtn.addEventListener('click', () => {
    sourceText.value = '';
    targetText.value = '';
    sourceLang.value = '';
    targetLang.value = '';
    sourceLangDetected.textContent = '';
    targetLangDetected.textContent = '';
    wordCount.textContent = `0 / ${WORD_COUNT_LIMIT} words`;
    wordCount.classList.remove('word-count-exceeded');
    sourceText.style.borderColor = 'rgb(60, 60, 60)';
    errorMessage.style.display = 'none';
    resultsContainer.style.display = 'none';
    targetDisplayContainer.style.display = 'none';
    applyAllBtn.style.display = 'none';
    undoBtn.style.display = 'none';
    correctedTextContainer.style.display = 'none';
    currentIssues = [];
    issueToSegmentMap = {};
    appliedCorrections = {};
    changeHistory = [];
    isOverLimit = false;
    updateAnalyzeButton();
  });

  // Run MQM analysis
  analyzeBtn.addEventListener('click', async () => {
    // Check if in monolingual mode
    const isMonolingual = document.getElementById('translation-mode-toggle').checked;
    console.log('Running assessment in mode:', isMonolingual ? 'monolingual' : 'bilingual');
    
    if (!isMonolingual && (!sourceText.value || !targetText.value || !sourceLang.value || !targetLang.value)) {
      showError('Please enter both source and target text and select languages');
      return;
    } else if (isMonolingual && (!targetText.value || !targetLang.value)) {
      showError('Please enter the text to analyze and select a language');
      return;
    }
    
    if (isOverLimit) {
      showError(`Source text exceeds the ${WORD_COUNT_LIMIT} word limit`);
      return;
    }
    
    // Show loading state with animated emoji
    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = '<span class="spinner">⟳</span> Analyzing...';
    errorMessage.style.display = 'none';
    
    // Create and show animated loading indicator
    const loadingIndicator = document.createElement('div');
    loadingIndicator.id = 'analysis-loading-indicator';
    loadingIndicator.innerHTML = `
      <div class="loading-animation">
        <div class="dancing-emoji">🧠</div>
        <div class="loading-text">ORCA is analyzing your text...</div>
        <div class="progress-bar"><div class="progress-fill"></div></div>
      </div>
    `;
    document.querySelector('.container').appendChild(loadingIndicator);
    
    // Animate the progress bar
    const progressFill = loadingIndicator.querySelector('.progress-fill');
    let progress = 0;
    const progressInterval = setInterval(() => {
      progress += 1;
      if (progress > 95) {
        clearInterval(progressInterval);
      }
      progressFill.style.width = `${progress}%`;
    }, 100);
    
    // Reset previous corrections and history
    appliedCorrections = {};
    changeHistory = [];
    
    try {
      // For development/testing without backend
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        // Simulate API call with a delay
        setTimeout(() => {
          const words = sourceText.value.trim().split(/\s+/);
          const wordCount = words.length > 0 && words[0] !== '' ? words.length : 0;
          const mockResults = generateMockResults(wordCount, isMonolingual);
          
          // Store current issues and target text
          currentIssues = mockResults.mqmIssues;
          currentTargetText = targetText.value;
          
          // Process and display results
          displayResults(mockResults);
          
          // Show the target display with highlighted issues
          highlightIssuesInText(targetText.value, mockResults.mqmIssues);
          
          // Reset button state
          analyzeBtn.disabled = false;
          analyzeBtn.textContent = 'Run Quality Check';
          
          // Show apply all button and undo button if there are issues
          if (mockResults.mqmIssues && mockResults.mqmIssues.length > 0) {
            applyAllBtn.style.display = 'block';
            undoBtn.style.display = 'block';
            undoBtn.disabled = true; // Initially disabled until changes are made
          }
        }, 1500);
        return;
      }
      
      // Step 1: Call /api/check-alignment before /api/mqm-analysis (skip for monolingual)
      // Skip alignment check for monolingual mode
      if (!isMonolingual && sourceText.value && targetText.value) {
        const alignmentResponse = await fetch('/api/check-alignment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sourceText: sourceText.value,
            targetText: targetText.value,
            sourceLang: sourceLang.value,
            targetLang: targetLang.value
          })
        });
        
        if (!alignmentResponse.ok) {
          const errorData = await alignmentResponse.json();
          throw new Error(errorData.error || 'Source/target alignment check failed');
        }
      }

      // Step 2: If alignment passes or in monolingual mode, proceed with MQM analysis
      // Get the selected LLM model
      const llmModelSelect = document.getElementById('llm-model');
      const selectedModel = llmModelSelect.value;
      
      // Track when we started the analysis
      const startTime = Date.now();
      
      // Show a message that we're waiting for the AI to analyze the text
      const waitingMessage = document.createElement('div');
      waitingMessage.id = 'waiting-message';
      waitingMessage.textContent = 'Waiting for AI analysis...';
      waitingMessage.style.textAlign = 'center';
      waitingMessage.style.marginTop = '20px';
      waitingMessage.style.color = '#666';
      waitingMessage.style.fontStyle = 'italic';
      document.querySelector('.container').appendChild(waitingMessage);
      
      // Set a timeout to update the waiting message if it takes longer than expected
      const waitingTimeout = setTimeout(() => {
        if (waitingMessage && document.contains(waitingMessage)) {
          waitingMessage.textContent = 'Still analyzing... This might take a few more seconds';
        }
      }, 10000); // 10 seconds
      
      try {
        // Get the current mode from the toggle
        const isMonolingual = document.getElementById('translation-mode-toggle').checked;
        console.log('Sending analysis request in mode:', isMonolingual ? 'monolingual' : 'bilingual');
        
        // Prepare request data
        const requestData = {
          sourceText: isMonolingual ? '' : sourceText.value,
          targetText: targetText.value,
          sourceLang: isMonolingual ? '' : sourceLang.value,
          targetLang: targetLang.value,
          mode: isMonolingual ? 'monolingual' : 'bilingual',
          llmModel: selectedModel // Include the selected LLM model
        };
        
        console.log('Sending request to /api/mqm-analysis with data:', JSON.stringify(requestData));
        
        // Make API request
        const response = await fetch('/api/mqm-analysis', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });
        
        console.log(`Response status: ${response.status}`);
        
        // Log the raw response for debugging
        const responseText = await response.text();
        console.log('Raw response:', responseText);
        
        // Check if the response is valid JSON
        let responseData;
        try {
          responseData = JSON.parse(responseText);
          console.log('Parsed response data:', responseData);
        } catch (parseError) {
          console.error('Error parsing response JSON:', parseError);
          throw new Error('Invalid response format from server');
        }
        
        if (!response.ok) {
          throw new Error(responseData.error || 'Analysis failed');
        }
        
        // Use the parsed data instead of parsing again
        const results = responseData;
        
        // Remove the waiting message
        clearTimeout(waitingTimeout);
        if (waitingMessage && document.contains(waitingMessage)) {
          waitingMessage.remove();
        }
        
        // Store current issues and target text
        currentIssues = results.mqmIssues;
        currentTargetText = targetText.value;
        
        // Process and display results
        displayResults(results);
        
        // Show the target display with highlighted issues
        highlightIssuesInText(targetText.value, results.mqmIssues);
        
        // Always enable Excel report download buttons
        const downloadBtns = document.getElementById('download-buttons');
        downloadBtns.style.display = 'flex';
        
        // If we have a run ID, use the server API, otherwise use client-side generation
        const runId = results._id;
        document.getElementById('download-excel-btn').onclick = async () => {
          if (runId) {
            // Server-side generation
            window.open(`/api/download-report/${runId}/excel`, '_blank');
          } else {
            // Client-side generation
            try {
              // Load XLSX library if not already loaded
              await loadXLSXLibrary();
              generateAndDownloadExcelReport(results);
            } catch (error) {
              console.error('Error loading XLSX library:', error);
              showNotification('Failed to generate Excel report. Please try again.', 'error');
            }
          }
        };
        
        // Show apply all button and undo button if there are issues
        if (results.mqmIssues && results.mqmIssues.length > 0) {
          applyAllBtn.style.display = 'block';
          undoBtn.style.display = 'block';
          undoBtn.disabled = true; // Initially disabled until changes are made
        }
      } catch (error) {
        console.error('MQM analysis error in API call:', error);
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = 'Run Quality Check';
        
        // Only show the error if it's not the temporary parsing error
        // or if we've been waiting too long (more than 5 seconds)
        if (error.message !== 'Could not parse analysis results' || Date.now() - startTime > 5000) {
          showError(error.message || 'Analysis failed');
        }
        
        // Remove waiting message if it exists
        clearTimeout(waitingTimeout);
        if (waitingMessage && document.contains(waitingMessage)) {
          waitingMessage.remove();
        }
        
        // Return early to avoid the outer catch block
        return;
      }
    } finally {
      // Always clean up the loading indicator
      const loadingIndicator = document.getElementById('analysis-loading-indicator');
      if (loadingIndicator) {
        loadingIndicator.remove();
      }
      // Clear any progress intervals
      clearInterval(progressInterval);
    }
  });

// Show admin modal
window.showAdminModal = function() {
  if (!authState.isAuthenticated || authState.accountType !== 'admin') {
    return;
  }
  
  const modal = document.getElementById('admin-modal');
  showModal(modal);
  
  // Load admin data
  loadAdminData();
};

    // Load admin dashboard data
    async function loadAdminData() {
      if (!authState.isAuthenticated || authState.accountType !== 'admin') {
        return;
      }
      
      const container = document.getElementById('admin-user-list');
      if (!container) return;
      
      // Show loading state
      container.innerHTML = '<p class="text-center mt-4">Loading users...</p>';
      
      try {
        const response = await fetch('/api/admin/users', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${authState.token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to load user data');
        }
        
        const data = await response.json();
        const users = data.users || [];
        
        if (users.length === 0) {
          container.innerHTML = '<div class="run-list-empty">No users found.</div>';
          return;
        }
        
        // Build HTML for users
        let html = '<table style="width: 100%; border-collapse: collapse;">';
        html += '<tr style="border-bottom: 1px solid var(--border-light); font-weight: 500;">';
        html += '<th style="text-align: left; padding: 10px;">Email</th>';
        html += '<th style="text-align: left; padding: 10px;">Account Type</th>';
        html += '<th style="text-align: left; padding: 10px;">Runs Used</th>';
        html += '<th style="text-align: left; padding: 10px;">Actions</th>';
        html += '</tr>';
        
        users.forEach(user => {
          html += '<tr style="border-bottom: 1px solid var(--border-light);">';
          html += `<td style="padding: 10px;">${user.email}</td>`;
          html += `<td style="padding: 10px;">${user.accountType}</td>`;
          html += `<td style="padding: 10px;">${user.runsUsed || 0}</td>`;
          html += '<td style="padding: 10px;">';
          html += `<button class="run-action-btn" onclick="changeUserType('${user._id}', 'free')">Set Free</button>`;
          html += `<button class="run-action-btn" onclick="changeUserType('${user._id}', 'paid')">Set Paid</button>`;
          html += `<button class="run-action-btn" onclick="changeUserType('${user._id}', 'admin')">Set Admin</button>`;
          html += '</td>';
          html += '</tr>';
        });
        
        html += '</table>';
        container.innerHTML = html;
      } catch (error) {
        console.error('Error loading admin data:', error);
        container.innerHTML = '<div class="run-list-empty">Error loading user data. Please try again.</div>';
      }
    }

    // Change user account type (admin function)
    window.changeUserType = async function(userId, accountType) {
      if (!authState.isAuthenticated || authState.accountType !== 'admin') {
        return;
      }
      
      try {
        const response = await fetch(`/api/admin/users/${userId}/account-type`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${authState.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ accountType })
        });
        
        if (!response.ok) {
          throw new Error('Failed to update user account type');
        }
        
        // Refresh admin data
        loadAdminData();
      } catch (error) {
        console.error('Error updating user account type:', error);
        alert('Failed to update user account type. Please try again.');
      }
    };

    // Modal helper functions
    function showModal(modal) {
      if (!modal) return;
      
      // Hide all other modals first
      document.querySelectorAll('.modal-overlay').forEach(m => {
        if (m !== modal) {
          m.style.display = 'none';
        }
      });
      
      // Show the modal
      modal.style.display = 'flex';
    }

    function hideModal(modal) {
      if (!modal) return;
      modal.style.display = 'none';
    }

    function hideAllModals() {
      document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.style.display = 'none';
      });
    }

    // Check if user can run assessment
    function canRunAssessment() {
      // Paid and admin users have unlimited runs
      if (authState.accountType === 'paid' || authState.accountType === 'admin') {
        return true;
      }
      
      // Others are limited
      return authState.runsUsed < authState.runLimit;
    }

    // Intercept the analyze button click to check usage limits
    const originalAnalyzeClick = analyzeBtn.onclick;
    analyzeBtn.onclick = async function(event) {
      // Prevent the original handler from running immediately
      event.preventDefault();
      
      // Check if user can run assessment
      if (!canRunAssessment()) {
        if (authState.isAuthenticated) {
          // Registered user needs to upgrade
          alert(`You've reached your limit of ${authState.runLimit} assessments. Please upgrade to continue.`);
          showSubscriptionModal();
        } else {
          // Anonymous user needs to register
          alert(`You've reached your limit of ${authState.runLimit} anonymous assessments. Please register for more.`);
          showRegisterModal();
        }
        return;
      }
      
      // If we have usage left, run the original handler
      analyzeBtn.disabled = true;
      analyzeBtn.innerHTML = '<span class="spinner">⟳</span> Analyzing...';
      errorMessage.style.display = 'none';
      
      try {
        // For development/testing without backend
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          // Simulate API call with a delay
          setTimeout(() => {
            const words = sourceText.value.trim().split(/\s+/);
            const wordCount = words.length > 0 && words[0] !== '' ? words.length : 0;
            const mockResults = generateMockResults(wordCount);
            
            // Store current issues and target text
            currentIssues = mockResults.mqmIssues;
            currentTargetText = targetText.value;
            
            // Process and display results
            displayResults(mockResults);
            
            // Show the target display with highlighted issues
            highlightIssuesInText(targetText.value, mockResults.mqmIssues);
            
            // Reset button state
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = 'Run Quality Check';
            
            // Show apply all button and undo button if there are issues
            if (mockResults.mqmIssues && mockResults.mqmIssues.length > 0) {
              applyAllBtn.style.display = 'block';
              undoBtn.style.display = 'block';
              undoBtn.disabled = true; // Initially disabled until changes are made
            }
            
            // Update usage count
            if (authState.accountType !== 'admin' && authState.accountType !== 'paid') {
              authState.runsUsed++;
              updateAuthUI();
            }
          }, 1500);
          return;
        }
        
        // Step 1: Call /api/check-alignment before /api/mqm-analysis
        const alignmentResponse = await fetch('/api/check-alignment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(authState.token ? { 'Authorization': `Bearer ${authState.token}` } : {})
          },
          body: JSON.stringify({
            sourceText: sourceText.value,
            targetText: targetText.value,
            sourceLang: sourceLang.value,
            targetLang: targetLang.value
          })
        });

        if (!alignmentResponse.ok) {
          const errorData = await alignmentResponse.json();
          throw new Error(errorData.error || 'Source/target alignment check failed');
        }

        // Step 2: If alignment passes, proceed with MQM analysis
        const mqmResponse = await fetch('/api/mqm-analysis', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(authState.token ? { 'Authorization': `Bearer ${authState.token}` } : {})
          },
          body: JSON.stringify({
            sourceText: sourceText.value,
            targetText: targetText.value,
            sourceLang: sourceLang.value,
            targetLang: targetLang.value
          })
        });

        if (!mqmResponse.ok) {
          const errorData = await mqmResponse.json();
          throw new Error(errorData.error || 'Analysis failed');
        }

        const results = await mqmResponse.json();
        
        // Store current issues and target text
        currentIssues = results.mqmIssues;
        currentTargetText = targetText.value;
        
        // Process and display results
        displayResults(results);
        
        // Show the target display with highlighted issues
        highlightIssuesInText(targetText.value, results.mqmIssues);
        
        // Show apply all button and undo button if there are issues
        if (results.mqmIssues && results.mqmIssues.length > 0) {
          applyAllBtn.style.display = 'block';
          undoBtn.style.display = 'block';
          undoBtn.disabled = true; // Initially disabled until changes are made
        }
        
        // Update usage count if analysis was successful
        if (authState.accountType !== 'admin' && authState.accountType !== 'paid') {
          authState.runsUsed++;
          updateAuthUI();
        }
        
        // Update current run ID
        if (results._id) {
          currentRunId = results._id;
          
          // Show save button if user is logged in
          if (authState.isAuthenticated) {
            saveRunBtn.style.display = 'block';
            saveRunBtn.onclick = () => saveCurrentRun(results._id);
          }
          
          // Enable Excel download
          const downloadBtns = document.getElementById('download-buttons');
          downloadBtns.style.display = 'flex';
          
          document.getElementById('download-excel-btn').onclick = () => {
            window.open(`/api/download-report/${results._id}/excel`, '_blank');
          };
        }
      } catch (error) {
        console.error('Error during analysis:', error);
        showError(error.message || 'An error occurred during analysis');
      } finally {
        // Reset button state
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = 'Run Quality Check';
      }
    };

    // Add similar interception for Excel upload form
    const originalExcelSubmit = excelUploadForm.onsubmit;
    excelUploadForm.onsubmit = async function(event) {
      // Prevent the original handler from running immediately
      event.preventDefault();
      
      // Check if user can run assessment
      if (!canRunAssessment()) {
        if (authState.isAuthenticated) {
          // Registered user needs to upgrade
          alert(`You've reached your limit of ${authState.runLimit} assessments. Please upgrade to continue.`);
          showSubscriptionModal();
        } else {
          // Anonymous user needs to register
          alert(`You've reached your limit of ${authState.runLimit} anonymous assessments. Please register for more.`);
          showRegisterModal();
        }
        return;
      }
      
      // Check if file is selected
      const file = excelFileInput.files[0];
      if (!file) {
        showError('Please select an Excel file to upload');
        return;
      }
      
      // Show loading state
      excelUploadBtn.disabled = true;
      excelUploadBtn.innerHTML = '<span class="spinner">⟳</span> Uploading...';
      errorMessage.style.display = 'none';
      excelUploadStatus.innerHTML = '<div style="color: var(--brand-teal);">Processing your Excel file, please wait...</div>';
      excelUploadStatus.style.display = 'block';
      
      // Create form data for the file upload
      const formData = new FormData();
      formData.append('excelFile', file);
      
      try {
        // Upload the file
        const response = await fetch('/api/upload-excel', {
          method: 'POST',
          headers: {
            ...(authState.token ? { 'Authorization': `Bearer ${authState.token}` } : {})
          },
          body: formData
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Upload failed');
        }
        
        // Process successful response
        const results = await response.json();
        
        // Update upload status message
        excelUploadStatus.innerHTML = '<div style="color: var(--severity-success);">✓ Excel processed successfully!</div>';
        
        // Store current issues and target text
        currentIssues = results.mqmIssues;
        
        // Extract and set source and target text from the response
        if (results.sourceText && results.targetText) {
          sourceText.value = results.sourceText;
          targetText.value = results.targetText;
          updateWordCountDisplay();
        }
        
        // Set language values if provided
        if (results.sourceLang) {
          sourceLang.value = results.sourceLang;
          const flag = getLanguageFlag(results.sourceLang);
          const name = getLanguageName(results.sourceLang);
          sourceLangDetected.textContent = `Selected: ${flag} ${name}`;
        }
        
        if (results.targetLang) {
          targetLang.value = results.targetLang;
          const flag = getLanguageFlag(results.targetLang);
          const name = getLanguageName(results.targetLang);
          targetLangDetected.textContent = `Selected: ${flag} ${name}`;
        }
        
        // Process and display results
        displayResults(results);
        
        // Show the target display with highlighted issues
        if (results.targetText) {
          highlightIssuesInText(results.targetText, results.mqmIssues);
        }
        
        // Show apply all button and undo button if there are issues
        if (results.mqmIssues && results.mqmIssues.length > 0) {
          applyAllBtn.style.display = 'block';
          undoBtn.style.display = 'block';
          undoBtn.disabled = true; // Initially disabled until changes are made
        }
        
        // Update usage count if analysis was successful
        if (authState.accountType !== 'admin' && authState.accountType !== 'paid') {
          authState.runsUsed++;
          updateAuthUI();
        }
        
        // Update current run ID
        if (results._id) {
          currentRunId = results._id;
          
          // Show save button if user is logged in
          if (authState.isAuthenticated) {
            saveRunBtn.style.display = 'block';
            saveRunBtn.onclick = () => saveCurrentRun(results._id);
          }
          
          // Enable Excel download
          const downloadBtns = document.getElementById('download-buttons');
          downloadBtns.style.display = 'flex';
          
          document.getElementById('download-excel-btn').onclick = () => {
            window.open(`/api/download-report/${results._id}/excel`, '_blank');
          };
        }
        
        // Scroll down to results
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        console.error('Excel upload error:', error);
        excelUploadStatus.innerHTML = `<div style="color: var(--severity-critical);">❌ Error: ${error.message || 'Failed to process Excel file'}</div>`;
        showError(error.message || 'An error occurred while processing the Excel file');
      } finally {
        // Reset button state
        excelUploadBtn.disabled = false;
        excelUploadBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 8px; vertical-align: text-bottom;">
            <path d="M.5 3a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h15a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5H.5zm1.5.5A.5.5 0 0 1 2.5 3h11a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5v-1z"/>
          </svg>
          Upload & Analyze
        `;
      }
    };
  </script>
  
  <!-- Direct monolingual toggle fix -->
  <script>
    // This script runs after the page is fully loaded to ensure monolingual toggle works
    document.addEventListener('DOMContentLoaded', function() {
      // Get the toggle element
      const toggle = document.getElementById('translation-mode-toggle');
      if (!toggle) {
        console.error('Translation mode toggle not found');
        return;
      }
      
      // Get the source container directly by ID
      const sourceContainer = document.getElementById('source-text-container');
      if (!sourceContainer) {
        console.error('Source container not found');
        return;
      }
      
      // Add a direct event listener to the toggle
      toggle.addEventListener('change', function() {
        // Direct manipulation of the source container display
        if (this.checked) {
          // Monolingual mode - hide source
          sourceContainer.style.display = 'none';
          console.log('DIRECT TOGGLE: Source container hidden');
          // Clear source inputs
          const sourceText = document.getElementById('source-text');
          const sourceLang = document.getElementById('source-lang');
          if (sourceText) sourceText.value = '';
          if (sourceLang) sourceLang.value = '';
        } else {
          // Bilingual mode - show source
          sourceContainer.style.display = 'block';
          console.log('DIRECT TOGGLE: Source container shown');
        }
      });
      
      // Force initial state based on toggle
      if (toggle.checked) {
        sourceContainer.style.display = 'none';
        console.log('INITIAL STATE: Source container hidden (monolingual mode)');
      } else {
        sourceContainer.style.display = 'block';
        console.log('INITIAL STATE: Source container shown (bilingual mode)');
      }
    });
  </script>
</body>
</html>